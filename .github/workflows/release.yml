name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build All Platforms
    runs-on: ubuntu-latest
    environment: Release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build Docker image for x86_64
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --load \
            -t skylight-builder \
            .

      - name: Set up Android signing
        run: |
          # Decode keystore from base64
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ./android/keystore.jks
          readlink -f ./android/keystore.jks
          stat -c %s ./android/keystore.jks
          
          # Create key.properties file
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=/workspace/android/keystore.jks
          EOF

      - name: Build Android APKs and App Bundle
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -w /workspace \
            skylight-builder \
            bash -c '
              flutter pub get && \
              flutter build apk --dart-define=DEMO_MODE=true --release --split-per-abi && \
              flutter build appbundle --dart-define=DEMO_MODE=true --release && \
              cd build/app/outputs/flutter-apk && \
              mv app-x86_64-release.apk skylight-wallet-${{ steps.version.outputs.VERSION }}-x86_64.apk || true && \
              mv app-armeabi-v7a-release.apk skylight-wallet-${{ steps.version.outputs.VERSION }}-armeabi-v7a.apk || true && \
              mv app-arm64-v8a-release.apk skylight-wallet-${{ steps.version.outputs.VERSION }}-arm64-v8a.apk || true && \
              cd ../bundle/release && \
              mv app-release.aab skylight-wallet-${{ steps.version.outputs.VERSION }}.aab
            '

      - name: Build Linux x86_64
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -w /workspace \
            skylight-builder \
            bash -c '
              flutter pub get && \
              ./appimage/build_appimage.sh --version ${{ steps.version.outputs.VERSION }}
            '

      - name: Fix permissions on build artifacts
        run: |
          sudo chown -R $USER:$USER build/ appimage/

      - name: List built artifacts
        run: |
          echo "=== Android APKs ==="
          ls -lh build/app/outputs/flutter-apk/*.apk || true
          echo "=== Android App Bundle ==="
          ls -lh build/app/outputs/bundle/release/*.aab || true
          echo "=== Linux AppImage ==="
          ls -lh appimage/skylight-wallet-*.AppImage || true

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Get the key ID for signing
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -n1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV

      - name: Sign artifacts with GPG
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # Sign Android APKs
          for file in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$file" ]; then
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --detach-sign --armor "$file"
              echo "Signed: $file"
            fi
          done
          
          # Sign Android App Bundle
          for file in build/app/outputs/bundle/release/*.aab; do
            if [ -f "$file" ]; then
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --detach-sign --armor "$file"
              echo "Signed: $file"
            fi
          done
          
          # Sign Linux AppImage
          for file in appimage/skylight-wallet-*.AppImage; do
            if [ -f "$file" ]; then
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --detach-sign --armor "$file"
              echo "Signed: $file"
            fi
          done
          
          echo "=== Generated signatures ==="
          find . -name "*.asc" -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.TAG }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            build/app/outputs/flutter-apk/*-x86_64.apk
            build/app/outputs/flutter-apk/*-x86_64.apk.asc
            build/app/outputs/flutter-apk/*-armeabi-v7a.apk
            build/app/outputs/flutter-apk/*-armeabi-v7a.apk.asc
            build/app/outputs/flutter-apk/*-arm64-v8a.apk
            build/app/outputs/flutter-apk/*-arm64-v8a.apk.asc
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/bundle/release/*.aab.asc
            appimage/skylight-wallet-*.AppImage
            appimage/skylight-wallet-*.AppImage.asc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
